'use strict'

var vendors = require('./vendors.json')

var env = process.env

// Used for testing only
Object.defineProperty(exports, '_vendors', ***REMOVED***
  value: vendors.map(function (v) ***REMOVED*** return v.constant ***REMOVED***)
***REMOVED***)

exports.name = null
exports.isPR = null

vendors.forEach(function (vendor) ***REMOVED***
  var envs = Array.isArray(vendor.env) ? vendor.env : [vendor.env]
  var isCI = envs.every(function (obj) ***REMOVED***
    return checkEnv(obj)
  ***REMOVED***)

  exports[vendor.constant] = isCI

  if (isCI) ***REMOVED***
    exports.name = vendor.name

    switch (typeof vendor.pr) ***REMOVED***
      case 'string':
        // "pr": "CIRRUS_PR"
        exports.isPR = !!env[vendor.pr]
        break
      case 'object':
        if ('env' in vendor.pr) ***REMOVED***
          // "pr": ***REMOVED*** "env": "BUILDKITE_PULL_REQUEST", "ne": "false" ***REMOVED***
          exports.isPR = vendor.pr.env in env && env[vendor.pr.env] !== vendor.pr.ne
        ***REMOVED*** else if ('any' in vendor.pr) ***REMOVED***
          // "pr": ***REMOVED*** "any": ["ghprbPullId", "CHANGE_ID"] ***REMOVED***
          exports.isPR = vendor.pr.any.some(function (key) ***REMOVED***
            return !!env[key]
          ***REMOVED***)
        ***REMOVED*** else ***REMOVED***
          // "pr": ***REMOVED*** "DRONE_BUILD_EVENT": "pull_request" ***REMOVED***
          exports.isPR = checkEnv(vendor.pr)
        ***REMOVED***
        break
      default:
        // PR detection not supported for this vendor
        exports.isPR = null
    ***REMOVED***
  ***REMOVED***
***REMOVED***)

exports.isCI = !!(
  env.CI || // Travis CI, CircleCI, Cirrus CI, Gitlab CI, Appveyor, CodeShip, dsari
  env.CONTINUOUS_INTEGRATION || // Travis CI, Cirrus CI
  env.BUILD_NUMBER || // Jenkins, TeamCity
  env.RUN_ID || // TaskCluster, dsari
  exports.name ||
  false
)

function checkEnv (obj) ***REMOVED***
  if (typeof obj === 'string') return !!env[obj]
  return Object.keys(obj).every(function (k) ***REMOVED***
    return env[k] === obj[k]
  ***REMOVED***)
***REMOVED***
