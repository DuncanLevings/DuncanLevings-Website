'use strict';
const errors = require('./errors');
const asStream = require('./as-stream');
const asPromise = require('./as-promise');
const normalizeArguments = require('./normalize-arguments');
const merge = require('./merge');
const deepFreeze = require('./utils/deep-freeze');

const getPromiseOrStream = options => options.stream ? asStream(options) : asPromise(options);

const aliases = [
	'get',
	'post',
	'put',
	'patch',
	'head',
	'delete'
];

const create = defaults => ***REMOVED***
	defaults = merge(***REMOVED******REMOVED***, defaults);
	normalizeArguments.preNormalize(defaults.options);

	if (!defaults.handler) ***REMOVED***
		// This can't be getPromiseOrStream, because when merging
		// the chain would stop at this point and no further handlers would be called.
		defaults.handler = (options, next) => next(options);
	***REMOVED***

	function got(url, options) ***REMOVED***
		try ***REMOVED***
			return defaults.handler(normalizeArguments(url, options, defaults), getPromiseOrStream);
		***REMOVED*** catch (error) ***REMOVED***
			if (options && options.stream) ***REMOVED***
				throw error;
			***REMOVED*** else ***REMOVED***
				return Promise.reject(error);
			***REMOVED***
		***REMOVED***
	***REMOVED***

	got.create = create;
	got.extend = options => ***REMOVED***
		let mutableDefaults;
		if (options && Reflect.has(options, 'mutableDefaults')) ***REMOVED***
			mutableDefaults = options.mutableDefaults;
			delete options.mutableDefaults;
		***REMOVED*** else ***REMOVED***
			mutableDefaults = defaults.mutableDefaults;
		***REMOVED***

		return create(***REMOVED***
			options: merge.options(defaults.options, options),
			handler: defaults.handler,
			mutableDefaults
		***REMOVED***);
	***REMOVED***;

	got.mergeInstances = (...args) => create(merge.instances(args));

	got.stream = (url, options) => got(url, ***REMOVED***...options, stream: true***REMOVED***);

	for (const method of aliases) ***REMOVED***
		got[method] = (url, options) => got(url, ***REMOVED***...options, method***REMOVED***);
		got.stream[method] = (url, options) => got.stream(url, ***REMOVED***...options, method***REMOVED***);
	***REMOVED***

	Object.assign(got, ***REMOVED***...errors, mergeOptions: merge.options***REMOVED***);
	Object.defineProperty(got, 'defaults', ***REMOVED***
		value: defaults.mutableDefaults ? defaults : deepFreeze(defaults),
		writable: defaults.mutableDefaults,
		configurable: defaults.mutableDefaults,
		enumerable: true
	***REMOVED***);

	return got;
***REMOVED***;

module.exports = create;
