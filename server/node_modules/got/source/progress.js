'use strict';
const ***REMOVED***Transform***REMOVED*** = require('stream');

module.exports = ***REMOVED***
	download(response, emitter, downloadBodySize) ***REMOVED***
		let downloaded = 0;

		return new Transform(***REMOVED***
			transform(chunk, encoding, callback) ***REMOVED***
				downloaded += chunk.length;

				const percent = downloadBodySize ? downloaded / downloadBodySize : 0;

				// Let `flush()` be responsible for emitting the last event
				if (percent < 1) ***REMOVED***
					emitter.emit('downloadProgress', ***REMOVED***
						percent,
						transferred: downloaded,
						total: downloadBodySize
					***REMOVED***);
				***REMOVED***

				callback(null, chunk);
			***REMOVED***,

			flush(callback) ***REMOVED***
				emitter.emit('downloadProgress', ***REMOVED***
					percent: 1,
					transferred: downloaded,
					total: downloadBodySize
				***REMOVED***);

				callback();
			***REMOVED***
		***REMOVED***);
	***REMOVED***,

	upload(request, emitter, uploadBodySize) ***REMOVED***
		const uploadEventFrequency = 150;
		let uploaded = 0;
		let progressInterval;

		emitter.emit('uploadProgress', ***REMOVED***
			percent: 0,
			transferred: 0,
			total: uploadBodySize
		***REMOVED***);

		request.once('error', () => ***REMOVED***
			clearInterval(progressInterval);
		***REMOVED***);

		request.once('response', () => ***REMOVED***
			clearInterval(progressInterval);

			emitter.emit('uploadProgress', ***REMOVED***
				percent: 1,
				transferred: uploaded,
				total: uploadBodySize
			***REMOVED***);
		***REMOVED***);

		request.once('socket', socket => ***REMOVED***
			const onSocketConnect = () => ***REMOVED***
				progressInterval = setInterval(() => ***REMOVED***
					const lastUploaded = uploaded;
					/* istanbul ignore next: see #490 (occurs randomly!) */
					const headersSize = request._header ? Buffer.byteLength(request._header) : 0;
					uploaded = socket.bytesWritten - headersSize;

					// Don't emit events with unchanged progress and
					// prevent last event from being emitted, because
					// it's emitted when `response` is emitted
					if (uploaded === lastUploaded || uploaded === uploadBodySize) ***REMOVED***
						return;
					***REMOVED***

					emitter.emit('uploadProgress', ***REMOVED***
						percent: uploadBodySize ? uploaded / uploadBodySize : 0,
						transferred: uploaded,
						total: uploadBodySize
					***REMOVED***);
				***REMOVED***, uploadEventFrequency);
			***REMOVED***;

			/* istanbul ignore next: hard to test */
			if (socket.connecting) ***REMOVED***
				socket.once('connect', onSocketConnect);
			***REMOVED*** else if (socket.writable) ***REMOVED***
				// The socket is being reused from pool,
				// so the connect event will not be emitted
				onSocketConnect();
			***REMOVED***
		***REMOVED***);
	***REMOVED***
***REMOVED***;
