/*!
 * on-headers
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict'

/**
 * Module exports.
 * @public
 */

module.exports = onHeaders

/**
 * Create a replacement writeHead method.
 *
 * @param ***REMOVED***function***REMOVED*** prevWriteHead
 * @param ***REMOVED***function***REMOVED*** listener
 * @private
 */

function createWriteHead (prevWriteHead, listener) ***REMOVED***
  var fired = false

  // return function with core name and argument list
  return function writeHead (statusCode) ***REMOVED***
    // set headers from arguments
    var args = setWriteHeadHeaders.apply(this, arguments)

    // fire listener
    if (!fired) ***REMOVED***
      fired = true
      listener.call(this)

      // pass-along an updated status code
      if (typeof args[0] === 'number' && this.statusCode !== args[0]) ***REMOVED***
        args[0] = this.statusCode
        args.length = 1
      ***REMOVED***
    ***REMOVED***

    return prevWriteHead.apply(this, args)
  ***REMOVED***
***REMOVED***

/**
 * Execute a listener when a response is about to write headers.
 *
 * @param ***REMOVED***object***REMOVED*** res
 * @return ***REMOVED***function***REMOVED*** listener
 * @public
 */

function onHeaders (res, listener) ***REMOVED***
  if (!res) ***REMOVED***
    throw new TypeError('argument res is required')
  ***REMOVED***

  if (typeof listener !== 'function') ***REMOVED***
    throw new TypeError('argument listener must be a function')
  ***REMOVED***

  res.writeHead = createWriteHead(res.writeHead, listener)
***REMOVED***

/**
 * Set headers contained in array on the response object.
 *
 * @param ***REMOVED***object***REMOVED*** res
 * @param ***REMOVED***array***REMOVED*** headers
 * @private
 */

function setHeadersFromArray (res, headers) ***REMOVED***
  for (var i = 0; i < headers.length; i++) ***REMOVED***
    res.setHeader(headers[i][0], headers[i][1])
  ***REMOVED***
***REMOVED***

/**
 * Set headers contained in object on the response object.
 *
 * @param ***REMOVED***object***REMOVED*** res
 * @param ***REMOVED***object***REMOVED*** headers
 * @private
 */

function setHeadersFromObject (res, headers) ***REMOVED***
  var keys = Object.keys(headers)
  for (var i = 0; i < keys.length; i++) ***REMOVED***
    var k = keys[i]
    if (k) res.setHeader(k, headers[k])
  ***REMOVED***
***REMOVED***

/**
 * Set headers and other properties on the response object.
 *
 * @param ***REMOVED***number***REMOVED*** statusCode
 * @private
 */

function setWriteHeadHeaders (statusCode) ***REMOVED***
  var length = arguments.length
  var headerIndex = length > 1 && typeof arguments[1] === 'string'
    ? 2
    : 1

  var headers = length >= headerIndex + 1
    ? arguments[headerIndex]
    : undefined

  this.statusCode = statusCode

  if (Array.isArray(headers)) ***REMOVED***
    // handle array case
    setHeadersFromArray(this, headers)
  ***REMOVED*** else if (headers) ***REMOVED***
    // handle object case
    setHeadersFromObject(this, headers)
  ***REMOVED***

  // copy leading arguments
  var args = new Array(Math.min(length, headerIndex))
  for (var i = 0; i < args.length; i++) ***REMOVED***
    args[i] = arguments[i]
  ***REMOVED***

  return args
***REMOVED***
