'use strict';
const pump = require('pump');
const bufferStream = require('./buffer-stream');

class MaxBufferError extends Error ***REMOVED***
	constructor() ***REMOVED***
		super('maxBuffer exceeded');
		this.name = 'MaxBufferError';
	***REMOVED***
***REMOVED***

function getStream(inputStream, options) ***REMOVED***
	if (!inputStream) ***REMOVED***
		return Promise.reject(new Error('Expected a stream'));
	***REMOVED***

	options = Object.assign(***REMOVED***maxBuffer: Infinity***REMOVED***, options);

	const ***REMOVED***maxBuffer***REMOVED*** = options;

	let stream;
	return new Promise((resolve, reject) => ***REMOVED***
		const rejectPromise = error => ***REMOVED***
			if (error) ***REMOVED*** // A null check
				error.bufferedData = stream.getBufferedValue();
			***REMOVED***
			reject(error);
		***REMOVED***;

		stream = pump(inputStream, bufferStream(options), error => ***REMOVED***
			if (error) ***REMOVED***
				rejectPromise(error);
				return;
			***REMOVED***

			resolve();
		***REMOVED***);

		stream.on('data', () => ***REMOVED***
			if (stream.getBufferedLength() > maxBuffer) ***REMOVED***
				rejectPromise(new MaxBufferError());
			***REMOVED***
		***REMOVED***);
	***REMOVED***).then(() => stream.getBufferedValue());
***REMOVED***

module.exports = getStream;
module.exports.buffer = (stream, options) => getStream(stream, Object.assign(***REMOVED******REMOVED***, options, ***REMOVED***encoding: 'buffer'***REMOVED***));
module.exports.array = (stream, options) => getStream(stream, Object.assign(***REMOVED******REMOVED***, options, ***REMOVED***array: true***REMOVED***));
module.exports.MaxBufferError = MaxBufferError;
