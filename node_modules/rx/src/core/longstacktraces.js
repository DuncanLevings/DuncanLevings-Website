  var STACK_JUMP_SEPARATOR = "From previous event:";

  function makeStackTraceLong(error, observable) ***REMOVED***
      // If possible, transform the error stack trace by removing Node and RxJS
      // cruft, then concatenating with the stack trace of `observable`.
      if (hasStacks &&
          observable.stack &&
          typeof error === "object" &&
          error !== null &&
          error.stack &&
          error.stack.indexOf(STACK_JUMP_SEPARATOR) === -1
      ) ***REMOVED***
        var stacks = [];
        for (var o = observable; !!o; o = o.source) ***REMOVED***
          if (o.stack) ***REMOVED***
            stacks.unshift(o.stack);
          ***REMOVED***
        ***REMOVED***
        stacks.unshift(error.stack);

        var concatedStacks = stacks.join("\n" + STACK_JUMP_SEPARATOR + "\n");
        error.stack = filterStackString(concatedStacks);
    ***REMOVED***
  ***REMOVED***

  function filterStackString(stackString) ***REMOVED***
    var lines = stackString.split("\n"),
        desiredLines = [];
    for (var i = 0, len = lines.length; i < len; i++) ***REMOVED***
      var line = lines[i];

      if (!isInternalFrame(line) && !isNodeFrame(line) && line) ***REMOVED***
        desiredLines.push(line);
      ***REMOVED***
    ***REMOVED***
    return desiredLines.join("\n");
  ***REMOVED***

  function isInternalFrame(stackLine) ***REMOVED***
    var fileNameAndLineNumber = getFileNameAndLineNumber(stackLine);
    if (!fileNameAndLineNumber) ***REMOVED***
      return false;
    ***REMOVED***
    var fileName = fileNameAndLineNumber[0], lineNumber = fileNameAndLineNumber[1];

    return fileName === rFileName &&
      lineNumber >= rStartingLine &&
      lineNumber <= rEndingLine;
  ***REMOVED***

  function isNodeFrame(stackLine) ***REMOVED***
    return stackLine.indexOf("(module.js:") !== -1 ||
      stackLine.indexOf("(node.js:") !== -1;
  ***REMOVED***

  function captureLine() ***REMOVED***
    if (!hasStacks) ***REMOVED*** return; ***REMOVED***

    try ***REMOVED***
      throw new Error();
    ***REMOVED*** catch (e) ***REMOVED***
      var lines = e.stack.split("\n");
      var firstLine = lines[0].indexOf("@") > 0 ? lines[1] : lines[2];
      var fileNameAndLineNumber = getFileNameAndLineNumber(firstLine);
      if (!fileNameAndLineNumber) ***REMOVED*** return; ***REMOVED***

      rFileName = fileNameAndLineNumber[0];
      return fileNameAndLineNumber[1];
    ***REMOVED***
  ***REMOVED***

  function getFileNameAndLineNumber(stackLine) ***REMOVED***
    // Named functions: "at functionName (filename:lineNumber:columnNumber)"
    var attempt1 = /at .+ \((.+):(\d+):(?:\d+)\)$/.exec(stackLine);
    if (attempt1) ***REMOVED*** return [attempt1[1], Number(attempt1[2])]; ***REMOVED***

    // Anonymous functions: "at filename:lineNumber:columnNumber"
    var attempt2 = /at ([^ ]+):(\d+):(?:\d+)$/.exec(stackLine);
    if (attempt2) ***REMOVED*** return [attempt2[1], Number(attempt2[2])]; ***REMOVED***

    // Firefox style: "function@filename:lineNumber or @filename:lineNumber"
    var attempt3 = /.*@(.+):(\d+)$/.exec(stackLine);
    if (attempt3) ***REMOVED*** return [attempt3[1], Number(attempt3[2])]; ***REMOVED***
  ***REMOVED***
