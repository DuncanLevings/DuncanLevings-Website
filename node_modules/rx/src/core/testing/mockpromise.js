  function MockPromise(scheduler, messages) ***REMOVED***
    var self = this;
    this.scheduler = scheduler;
    this.messages = messages;
    this.subscriptions = [];
    this.observers = [];
    for (var i = 0, len = this.messages.length; i < len; i++) ***REMOVED***
      var message = this.messages[i],
          notification = message.value;
      (function (innerNotification) ***REMOVED***
        scheduler.scheduleAbsoluteWithState(null, message.time, function () ***REMOVED***
          var obs = self.observers.slice(0);

          for (var j = 0, jLen = obs.length; j < jLen; j++) ***REMOVED***
            innerNotification.accept(obs[j]);
          ***REMOVED***
          return disposableEmpty;
        ***REMOVED***);
      ***REMOVED***)(notification);
    ***REMOVED***
  ***REMOVED***

  MockPromise.prototype.then = function (onResolved, onRejected) ***REMOVED***
    var self = this;

    this.subscriptions.push(new Subscription(this.scheduler.clock));
    var index = this.subscriptions.length - 1;

    var newPromise;

    var observer = Rx.Observer.create(
      function (x) ***REMOVED***
        var retValue = onResolved(x);
        if (retValue && typeof retValue.then === 'function') ***REMOVED***
          newPromise = retValue;
        ***REMOVED*** else ***REMOVED***
          var ticks = self.scheduler.clock;
          newPromise = new MockPromise(self.scheduler, [Rx.ReactiveTest.onNext(ticks, undefined), Rx.ReactiveTest.onCompleted(ticks)]);
        ***REMOVED***
        var idx = self.observers.indexOf(observer);
        self.observers.splice(idx, 1);
        self.subscriptions[index] = new Subscription(self.subscriptions[index].subscribe, self.scheduler.clock);
      ***REMOVED***,
      function (err) ***REMOVED***
        onRejected(err);
        var idx = self.observers.indexOf(observer);
        self.observers.splice(idx, 1);
        self.subscriptions[index] = new Subscription(self.subscriptions[index].subscribe, self.scheduler.clock);
      ***REMOVED***
    );
    this.observers.push(observer);

    return newPromise || new MockPromise(this.scheduler, this.messages);
  ***REMOVED***;
