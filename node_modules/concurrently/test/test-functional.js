// Test basic usage of cli

var path = require('path');
var assert = require('assert');
var run = require('./utils').run;
var IS_WINDOWS = /^win/.test(process.platform);

// Note: Set the DEBUG_TESTS environment variable to `true` to see output of test commands.

var TEST_DIR = 'dir/';

// Abs path to test directory
var testDir = path.resolve(__dirname);
process.chdir(path.join(testDir, '..'));

describe('concurrently', function() ***REMOVED***
    this.timeout(5000);

    it('help should be successful', () => ***REMOVED***
        return run('node ./src/main.js --help')
            .then(function(exitCode) ***REMOVED***
                // exit code 0 means success
                assert.strictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('version should be successful', () => ***REMOVED***
        return run('node ./src/main.js -V')
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('two successful commands should exit 0', () => ***REMOVED***
        return run('node ./src/main.js "echo test" "echo test"')
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('at least one unsuccessful commands should exit non-zero', () => ***REMOVED***
        return run('node ./src/main.js "echo test" "nosuchcmd" "echo test"')
            .then(function(exitCode) ***REMOVED***
                assert.notStrictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('--kill-others should kill other commands if one dies', () => ***REMOVED***
        return run('node ./src/main.js --kill-others "sleep 1" "echo test" "sleep 0.1 && nosuchcmd"')
            .then(function(exitCode) ***REMOVED***
                assert.notStrictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('--kill-others-on-fail should kill other commands if one exits with non-zero status code', () => ***REMOVED***
        return run('node ./src/main.js --kill-others-on-fail "sleep 1" "exit 1" "sleep 1"')
            .then(function(exitCode) ***REMOVED***
                assert.notStrictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('--kill-others-on-fail should NOT kill other commands if none of them exits with non-zero status code', (done) => ***REMOVED***
        var readline = require('readline');
        var exits = 0;
        var sigtermInOutput = false;

        run('node ./src/main.js --kill-others-on-fail "echo killTest1" "echo killTest2" "echo killTest3"', ***REMOVED***
            onOutputLine: function(line) ***REMOVED***
                if (/SIGTERM/.test(line)) ***REMOVED***
                    sigtermInOutput = true;
                ***REMOVED***

                // waiting for exits
                if (/killTest\d$/.test(line)) ***REMOVED***
                    exits++;
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***).then(function() ***REMOVED***
            if(sigtermInOutput) ***REMOVED***
                done(new Error('There was a "SIGTERM" in console output'));
            ***REMOVED*** else if (exits !== 3) ***REMOVED***
                done(new Error('There was wrong number of echoes(' + exits + ') from executed commands'));
            ***REMOVED*** else ***REMOVED***
                done();
            ***REMOVED***
        ***REMOVED***);
    ***REMOVED***);

    it('--success=first should return first exit code', () => ***REMOVED***
        return run('node ./src/main.js -k --success first "echo test" "sleep 0.1 && nosuchcmd"')
            // When killed, sleep returns null exit code
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('--success=last should return last exit code', () => ***REMOVED***
        // When killed, sleep returns null exit code
        return run('node ./src/main.js -k --success last "echo test" "sleep 0.1 && nosuchcmd"')
            .then(function(exitCode) ***REMOVED***
                assert.notStrictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('&& nosuchcmd should return non-zero exit code', () => ***REMOVED***
        return run('node ./src/main.js "echo 1 && nosuchcmd" "echo 1 && nosuchcmd" ')
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 1);
            ***REMOVED***);
    ***REMOVED***);

    it('--prefix-colors should handle non-existent colors without failing', () => ***REMOVED***
        return run('node ./src/main.js -c "not.a.color" "echo colors"')
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 0);
            ***REMOVED***);
    ***REMOVED***);

    it('--prefix should default to "index"', () => ***REMOVED***
        var collectedLines = []

        return run('node ./src/main.js "echo one" "echo two"', ***REMOVED***
            onOutputLine: (line) => ***REMOVED***
                if (/(one|two)$/.exec(line)) ***REMOVED***
                    collectedLines.push(line)
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***)
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 0);

                collectedLines.sort()
                assert.deepEqual(collectedLines, [
                    '[0] one',
                    '[1] two'
                ])
            ***REMOVED***);
    ***REMOVED***);

    it('--names should set a different default prefix', () => ***REMOVED***
        var collectedLines = []

        return run('node ./src/main.js -n aa,bb "echo one" "echo two"', ***REMOVED***
            onOutputLine: (line) => ***REMOVED***
                if (/(one|two)$/.exec(line)) ***REMOVED***
                    collectedLines.push(line)
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***)
            .then(function(exitCode) ***REMOVED***
                assert.strictEqual(exitCode, 0);

                collectedLines.sort()
                assert.deepEqual(collectedLines, [
                    '[aa] one',
                    '[bb] two'
                ])
            ***REMOVED***);
    ***REMOVED***);

    it('--allow-restart should restart a proccess with non-zero exit code', (done) => ***REMOVED***
        var readline = require('readline');
        var exitedWithOne = false;
        var restarted = false;

        run('node ./src/main.js --allow-restart "sleep 0.1 && exit 1" "sleep 1"', ***REMOVED***
            pipe: false,
            onOutputLine: (line) => ***REMOVED***
                var re = /exited with code (.+)/.exec(line);
                if (re && re[1] === '1') ***REMOVED***
                    exitedWithOne = true
                ***REMOVED***

                if (/restarted/.test(line)) ***REMOVED***
                    restarted = true;
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***).then(function() ***REMOVED***
            if (exitedWithOne && restarted) ***REMOVED***
                done();
            ***REMOVED*** else ***REMOVED***
                done(new Error('No restarted process exited with code 1'));
            ***REMOVED***
        ***REMOVED***);
    ***REMOVED***);

    it('--restart-after=n should restart a proccess after n miliseconds', (done) => ***REMOVED***
        var readline = require('readline');
        var start, end;

        run('node ./src/main.js --allow-restart --restart-after 300 "exit 1" "sleep 1"', ***REMOVED***
            pipe: false,
            onOutputLine: (line) => ***REMOVED***
                if (!start && /exited with code (.+)/.test(line)) ***REMOVED***
                    start = new Date().getTime();
                ***REMOVED***

                if (!end && /restarted/.test(line)) ***REMOVED***
                    end = new Date().getTime();
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***).then(function() ***REMOVED***
            // we accept 100 miliseconds of error
            if (end - start >= 300 && end - start < 400) ***REMOVED***
                done();
            ***REMOVED*** else ***REMOVED***
                done(new Error('No restarted process after 300 miliseconds'));
            ***REMOVED***
        ***REMOVED***);
    ***REMOVED***);
    it('--restart-tries=n should restart a proccess at most n times', (done) => ***REMOVED***
        var readline = require('readline');
        var restartedTimes = 0;

        run('node ./src/main.js --allow-restart --restart-tries 2 "exit 1" "sleep 1"', ***REMOVED***
            pipe: false,
            onOutputLine: (line) => ***REMOVED***
                if (/restarted/.test(line)) ***REMOVED***
                    restartedTimes++;
                ***REMOVED***
            ***REMOVED***
        ***REMOVED***).then(function() ***REMOVED***
            if (restartedTimes == 2) ***REMOVED***
                done();
            ***REMOVED*** else ***REMOVED***
                done(new Error('No restarted process twice'));
            ***REMOVED***
        ***REMOVED***);
    ***REMOVED***);

    ['SIGINT', 'SIGTERM'].forEach((signal) => ***REMOVED***
      if (IS_WINDOWS) ***REMOVED***
          console.log('IS_WINDOWS=true');
          console.log('Skipping SIGINT/SIGTERM propagation tests ..');
          return;
      ***REMOVED***

      it('killing it with ' + signal + ' should propagate the signal to the children', function(done) ***REMOVED***
        var readline = require('readline');
        var waitingStart = 2;
        var waitingSignal = 2;

        function waitForSignal(cb) ***REMOVED***
          if (waitingSignal) ***REMOVED***
            setTimeout(waitForSignal, 100);
          ***REMOVED*** else ***REMOVED***
            cb();
          ***REMOVED***
        ***REMOVED***

        run('node ./src/main.js "node ./test/support/signal.js" "node ./test/support/signal.js"', ***REMOVED***
          onOutputLine: function(line, child) ***REMOVED***
            // waiting for startup
            if (/STARTED/.test(line)) ***REMOVED***
              waitingStart--;
            ***REMOVED***
            if (!waitingStart) ***REMOVED***
              // both processes are started
              child.kill(signal);
            ***REMOVED***

            // waiting for signal
            if (new RegExp(signal).test(line)) ***REMOVED***
              waitingSignal--;
            ***REMOVED***
          ***REMOVED***
        ***REMOVED***).then(function() ***REMOVED***
          waitForSignal(done);
        ***REMOVED***);
      ***REMOVED***);
    ***REMOVED***);
***REMOVED***);

function resolve(relativePath) ***REMOVED***
    return path.join(testDir, relativePath);
***REMOVED***
